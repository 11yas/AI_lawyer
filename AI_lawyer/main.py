from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from pydantic import BaseModel
import requests
import json
import os
import asyncio
from concurrent.futures import ThreadPoolExecutor
import numpy as np
from sklearn.metrics.pairwise import cosine_similarity
from transformers import pipeline

from loader import load_pdfs, embedder
from sentence_transformers import CrossEncoder

# === App and settings ===
app = FastAPI(title="Law RAG Assistant")
executor = ThreadPoolExecutor(max_workers=4)

# === Load vector database ===
collection = load_pdfs("./laws")

# === Stronger reranker ===
reranker = CrossEncoder("cross-encoder/ms-marco-MiniLM-L-6-v2")

# === Question rephraser ===
rephraser = pipeline("text2text-generation", model="google/flan-t5-base")

def clarify_question(user_query: str) -> str:
    """–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π"""
    try:
        prompt = (
            f"–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å —è—Å–Ω–æ –∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ, "
            f"—á—Ç–æ–±—ã –æ–Ω –ø–æ–¥—Ö–æ–¥–∏–ª –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∑–∞–∫–æ–Ω–∞—Ö –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞. "
            f"–í–æ–ø—Ä–æ—Å: {user_query}"
        )
        result = rephraser(prompt, max_length=64, num_return_sequences=1)[0]['generated_text']
        return result.strip()
    except Exception as e:
        print("‚ö† –û—à–∏–±–∫–∞ reformulation:", e)
        return user_query


# === Query expander ===
def expand_query(q):
    synonyms = {
        # === –ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è –∏ –ø—Ä–∞–≤–æ–Ω–∞—Ä—É—à–µ–Ω–∏—è ===
        "–∫—Ä–∞–∂–∞": ["—Ö–∏—â–µ–Ω–∏–µ", "–≤–æ—Ä–æ–≤—Å—Ç–≤–æ", "—É–≥–æ–Ω", "–Ω–µ–∑–∞–∫–æ–Ω–Ω–æ–µ –∏–∑—ä—è—Ç–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞", "–ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ"],
        "–≥—Ä–∞–±–µ–∂": ["—Ä–∞–∑–±–æ–π", "–Ω–∞—Å–∏–ª—å—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ö–∏—â–µ–Ω–∏–µ", "–æ—Ç–∫—Ä—ã—Ç–æ–µ –ø–æ—Ö–∏—â–µ–Ω–∏–µ –∏–º—É—â–µ—Å—Ç–≤–∞"],
        "—É–±–∏–π—Å—Ç–≤–æ": ["–ª–∏—à–µ–Ω–∏–µ –∂–∏–∑–Ω–∏", "—É–º—ã—à–ª–µ–Ω–Ω–æ–µ –ø—Ä–∏—á–∏–Ω–µ–Ω–∏–µ —Å–º–µ—Ä—Ç–∏", "–ø–æ—Å—è–≥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –Ω–∞ –∂–∏–∑–Ω—å"],
        "–≤—ã–º–æ–≥–∞—Ç–µ–ª—å—Å—Ç–≤–æ": ["—à–∞–Ω—Ç–∞–∂", "–ø—Ä–∏–Ω—É–∂–¥–µ–Ω–∏–µ –∫ –ø–µ—Ä–µ–¥–∞—á–µ –∏–º—É—â–µ—Å—Ç–≤–∞", "—É–≥—Ä–æ–∑–∞ –Ω–∞—Å–∏–ª–∏–µ–º"],
        "–≤–∑—è—Ç–∫–∞": ["–ø–æ–¥–∫—É–ø", "–Ω–µ–∑–∞–∫–æ–Ω–Ω–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ", "–∫–æ—Ä—Ä—É–ø—Ü–∏—è"],
        "–º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ": ["–æ–±–º–∞–Ω", "–Ω–µ–∑–∞–∫–æ–Ω–Ω–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ", "–ø–æ–¥–¥–µ–ª–∫–∞", "—Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏"],
        "–Ω–∞—Ä–∫–æ—Ç–∏–∫–∏": ["–Ω–∞—Ä–∫–æ—Ç–∏—á–µ—Å–∫–∏–µ –≤–µ—â–µ—Å—Ç–≤–∞", "–∫–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥–∞ –Ω–∞—Ä–∫–æ—Ç–∏–∫–æ–≤", "–Ω–µ–∑–∞–∫–æ–Ω–Ω—ã–π –æ–±–æ—Ä–æ—Ç –Ω–∞—Ä–∫–æ—Ç–∏–∫–æ–≤"],
        "–Ω–∞—Å–∏–ª–∏–µ": ["–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∏–ª—ã", "—Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ", "—É–≥—Ä–æ–∑–∞ –∂–∏–∑–Ω–∏"],

        # === –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ ===
        "–Ω–∞–∫–∞–∑–∞–Ω–∏–µ": ["–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "—Å–∞–Ω–∫—Ü–∏—è", "—à—Ç—Ä–∞—Ñ", "—É–≥–æ–ª–æ–≤–Ω–æ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ", "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –º–µ—Ä–∞"],
        "—à—Ç—Ä–∞—Ñ": ["–¥–µ–Ω–µ–∂–Ω–æ–µ –≤–∑—ã—Å–∫–∞–Ω–∏–µ", "–ø–µ–Ω—è", "–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π —à—Ç—Ä–∞—Ñ"],
        "–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": ["—Å–∞–Ω–∫—Ü–∏–∏", "–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å –≤–æ–∑–º–µ—Å—Ç–∏—Ç—å —É—â–µ—Ä–±", "–º–µ—Ä–∞ –Ω–∞–∫–∞–∑–∞–Ω–∏—è"],

        # === –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–µ –ø—Ä–∞–≤–æ ===
        "–¥–æ–≥–æ–≤–æ—Ä": ["—Å–æ–≥–ª–∞—à–µ–Ω–∏–µ", "–∫–æ–Ω—Ç—Ä–∞–∫—Ç", "–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ", "–ø—Ä–∞–≤–æ–≤–æ–π –∞–∫—Ç"],
        "–¥–æ–≥–æ–≤–æ—Ä –ø–æ—Å—Ç–∞–≤–∫–∏": ["–∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É", "–ø–æ—Å—Ç–∞–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤", "–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Å–¥–µ–ª–∫–∞"],
        "–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ": ["–¥–æ–ª–≥", "–¥–æ–≥–æ–≤–æ—Ä–Ω–∞—è –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å", "–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π"],
        "—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ": ["–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è", "–æ—Ç–º–µ–Ω–∞ –¥–æ–≥–æ–≤–æ—Ä–∞"],
        "–Ω–µ—É—Å—Ç–æ–π–∫–∞": ["—à—Ç—Ä–∞—Ñ–Ω–∞—è —Å–∞–Ω–∫—Ü–∏—è", "–ø–µ–Ω—è", "–¥–µ–Ω–µ–∂–Ω–æ–µ –≤–∑—ã—Å–∫–∞–Ω–∏–µ"],
        "—É—â–µ—Ä–±": ["–≤—Ä–µ–¥", "–ø–æ—Ç–µ—Ä–∏", "–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π —É–±—ã—Ç–æ–∫", "–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è"],

        # === –¢—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ ===
        "—É–≤–æ–ª—å–Ω–µ–Ω–∏–µ": ["—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ —Ç—Ä—É–¥–æ–≤–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞", "–ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã", "–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ—Ç –¥–æ–ª–∂–Ω–æ—Å—Ç–∏"],
        "–∑–∞—Ä–ø–ª–∞—Ç–∞": ["–∑–∞—Ä–∞–±–æ—Ç–Ω–∞—è –ø–ª–∞—Ç–∞", "–æ–ø–ª–∞—Ç–∞ —Ç—Ä—É–¥–∞", "–¥–µ–Ω–µ–∂–Ω–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ"],
        "–æ—Ç–ø—É—Å–∫": ["–µ–∂–µ–≥–æ–¥–Ω—ã–π –æ—Ç–¥—ã—Ö", "–æ—Ç–≥—É–ª", "–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ—Ç —Ä–∞–±–æ—Ç—ã"],
        "—Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å": ["–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è", "—Ñ–∏—Ä–º–∞", "–∫–æ–º–ø–∞–Ω–∏—è", "–Ω–∞–Ω–∏–º–∞—Ç–µ–ª—å"],
        "—Ä–∞–±–æ—Ç–Ω–∏–∫": ["—Å–ª—É–∂–∞—â–∏–π", "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫", "—Ç—Ä—É–¥—è—â–∏–π—Å—è"],

        # === –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –∏ –Ω–∞–ª–æ–≥–æ–≤–æ–µ –ø—Ä–∞–≤–æ ===
        "–Ω–∞–ª–æ–≥": ["–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂", "—Å–±–æ—Ä", "–ø–æ—à–ª–∏–Ω–∞"],
        "–Ω–∞–ª–æ–≥–æ–ø–ª–∞—Ç–µ–ª—å—â–∏–∫": ["–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è", "–≥—Ä–∞–∂–¥–∞–Ω–∏–Ω", "–ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å"],
        "–±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ": ["–Ω–µ—Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "–ª–∏–∫–≤–∏–¥–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–∏", "—Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –Ω–µ–ø–ª–∞—Ç–µ–∂–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å"],
        "–∫–æ–º–ø–∞–Ω–∏—è": ["–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è", "—Ñ–∏—Ä–º–∞", "–ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ", "—é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ"],
        "–¥–æ–ª–∂–Ω–∏–∫": ["–æ–±—è–∑–∞–Ω–Ω–æ–µ –ª–∏—Ü–æ", "–∑–∞–µ–º—â–∏–∫", "–¥–µ–±–∏—Ç–æ—Ä"],
        "–∫—Ä–µ–¥–∏—Ç–æ—Ä": ["–≤–∑—ã—Å–∫–∞—Ç–µ–ª—å", "–ª–∏—Ü–æ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–≤—à–µ–µ –∑–∞—ë–º"],

        # === –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –∏ –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–æ ===
        "—Å—É–¥": ["—Å—É–¥–µ–±–Ω—ã–π –æ—Ä–≥–∞–Ω", "–ø—Ä–∞–≤–æ—Å—É–¥–∏–µ", "—Å—É–¥—å—è"],
        "–∑–∞–∫–æ–Ω": ["–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –∞–∫—Ç", "–∫–æ–¥–µ–∫—Å", "–ø—Ä–∞–≤–∏–ª–æ", "–∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ"],
        "–ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞": ["–Ω–∞–¥–∑–æ—Ä–Ω—ã–π –æ—Ä–≥–∞–Ω", "–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –æ–±–≤–∏–Ω–∏—Ç–µ–ª—å"],
        "–∂–∞–ª–æ–±–∞": ["–∞–ø–µ–ª–ª—è—Ü–∏—è", "–æ–±—Ä–∞—â–µ–Ω–∏–µ", "—Ö–æ–¥–∞—Ç–∞–π—Å—Ç–≤–æ"],
        "–ø–æ–ª–∏—Ü–∏—è": ["–ø—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ä–≥–∞–Ω—ã", "—Å–ª—É–∂–±–∞ –æ—Ö—Ä–∞–Ω—ã –ø–æ—Ä—è–¥–∫–∞"],

        # === –ë—ã—Ç–æ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è ===
        "–º–∞–≥–∞–∑–∏–Ω": ["—Ç–æ—Ä–≥–æ–≤—ã–π –æ–±—ä–µ–∫—Ç", "—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç", "—Ç–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞"],
        "–∏–º—É—â–µ—Å—Ç–≤–æ": ["–≤–µ—â–∏", "—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏"],
        "–¥–µ–Ω—å–≥–∏": ["–Ω–∞–ª–∏—á–Ω—ã–µ", "—Ñ–∏–Ω–∞–Ω—Å—ã", "—Å—Ä–µ–¥—Å—Ç–≤–∞"],
        "–¥–æ–ª–≥": ["–∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å", "–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –≤—ã–ø–ª–∞—Ç–∏—Ç—å", "—Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å"],
        "–æ–±–º–∞–Ω": ["–º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ", "–ª–æ–∂—å", "–≤–≤–µ–¥–µ–Ω–∏–µ –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ"],
    }
    for word, syns in synonyms.items():
        if word in q:
            q += " " + " ".join(syns)
    return q


# === Static + templates ===
app.mount("/static", StaticFiles(directory="static"), name="static")
templates = Jinja2Templates(directory="templates")


# === Request Model ===
class AskRequest(BaseModel):
    question: str
    model: str = "llama3.1:8b"


# === LLM connector ===
def ask_llm(prompt: str, model: str = "llama3.1:8b") -> str:
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ Ollama"""
    try:
        r = requests.post(
            "http://localhost:11434/api/generate",
            json={"model": model, "prompt": prompt, "stream": False},
            timeout=180,
        )
        data = r.json()
        return data.get("response", "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
    except Exception as e:
        print("‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ LLM:", e)
        return "–û—à–∏–±–∫–∞: –º–æ–¥–µ–ª—å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç."


# === Prompt builder ===
def build_prompt(question: str, context: str) -> str:
    return f"""
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç –ø–æ –∑–∞–∫–æ–Ω–∞–º –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.

–ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø—Ä–∏–≤–µ–¥—ë–Ω–Ω—ã–µ –Ω–∏–∂–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∑–∞–∫–æ–Ω–æ–≤.
–ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö –ø—Ä—è–º–æ –Ω–µ —Å–≤—è–∑–∞–Ω —Å –≤–æ–ø—Ä–æ—Å–æ–º ‚Äî –Ω–∞–ø–∏—à–∏ ¬´–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö¬ª.

‚öñÔ∏è –ü—Ä–∞–≤–∏–ª–∞:
- –ò–≥–Ω–æ—Ä–∏—Ä—É–π —Å—Ç–∞—Ç—å–∏, –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —Å—É—Ç–∏ –≤–æ–ø—Ä–æ—Å–∞.
- –ù–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π —Å–ª—É—á–∞–π–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ —Ç–æ–ª—å–∫–æ –ø–æ –Ω–æ–º–µ—Ä—É.
- –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã.
- –û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

üìö –§—Ä–∞–≥–º–µ–Ω—Ç—ã –∑–∞–∫–æ–Ω–∞:
{context}

‚ùì –í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: {question}

üí¨ –û—Ç–≤–µ—Ç (–∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É):
"""



# === Helper: async embedding ===
async def embed_text_async(text: str):
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(executor, embedder.encode, text)


# === Main endpoint ===
@app.post("/ask")
async def ask(req: AskRequest):
    # 1Ô∏è‚É£ –†–∞—Å—à–∏—Ä—è–µ–º –∏ —É—Ç–æ—á–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
    expanded = expand_query(req.question)
    clarified = clarify_question(expanded)
    print(f"üîç Reformulated query: {clarified}")

    # 2Ô∏è‚É£ –≠–º–±–µ–¥–¥–∏–Ω–≥ —É—Ç–æ—á–Ω—ë–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    q_emb = await embed_text_async(clarified)

    # 3Ô∏è‚É£ –ü–æ–∏—Å–∫ –ø–æ Chroma
    results = collection.query(
        query_embeddings=[q_emb],
        n_results=15,
        include=["documents", "metadatas", "embeddings"]
    )

    docs = results.get("documents", [[]])[0]
    metas = results.get("metadatas", [[]])[0]
    embs = results.get("embeddings", [[]])[0]

    if not docs:
        return {"answer": "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–∫–æ–Ω–µ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É.", "sources": []}

    # 4Ô∏è‚É£ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–º—É —Å—Ö–æ–¥—Å—Ç–≤—É
    similarities = cosine_similarity([q_emb], embs)[0]
    paired = list(zip(docs, metas, similarities))
    paired = sorted(paired, key=lambda x: x[2], reverse=True)
    filtered = [p for p in paired if p[2] > 0.6]
    if not filtered:
        return {"answer": "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–∫–æ–Ω–µ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É.", "sources": []}

    # 5Ô∏è‚É£ Reranking –ø–æ —Å–º—ã—Å–ª—É
    rerank_pairs = [(clarified, p[0]) for p in filtered]
    rerank_scores = reranker.predict(rerank_pairs)
    ranked = sorted(zip(filtered, rerank_scores), key=lambda x: x[1], reverse=True)
    ranked = [(d, m, s, r) for (d, m, s), r in ranked if r > 0.4][:5]
    if not ranked:
        return {"answer": "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–∫–æ–Ω–µ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É.", "sources": []}


    # 6Ô∏è‚É£ –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    context_parts = []
    for (doc, meta, score), rscore in ranked:
        snippet = doc.strip().replace("\n", " ")
        context_parts.append(
            f"[{meta.get('source', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')} | sim={score:.2f}, rank={rscore:.2f}]: {snippet[:800]}..."
        )
    context = "\n\n".join(context_parts)

    # 7Ô∏è‚É£ –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º LLM
    prompt = build_prompt(clarified, context)
    answer = ask_llm(prompt, req.model)

    return {
        "answer": answer,
        "sources": [meta for (_, meta, _), _ in ranked],
        "clarified": clarified,
        "context_used": len(context_parts),
    }


# === Web UI ===
@app.get("/", response_class=HTMLResponse)
def chat_ui(request: Request):
    return templates.TemplateResponse("index.html", {"request": request})


@app.get("/health")
def health():
    return {"status": "ok"}
